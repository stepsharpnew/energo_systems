name: Docker Compose CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üõéÔ∏è –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö secrets
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è secrets..."

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ secrets
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "‚ùå SERVER_HOST –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            exit 1
          else
            echo "‚úÖ SERVER_HOST —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
          fi

          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "‚ùå SERVER_USER –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            exit 1
          else
            echo "‚úÖ SERVER_USER —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${{ secrets.SERVER_USER }}"
          fi

          if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
            echo "‚ùå SERVER_SSH_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –ø—É—Å—Ç–æ–π!"
            echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ secret –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ SERVER_SSH_KEY"
            exit 1
          else
            echo "‚úÖ SERVER_SSH_KEY —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª–æ –∫–ª—é—á–∞ (–±–µ–∑ –≤—ã–≤–æ–¥–∞ –≤—Å–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ)
            KEY_START=$(echo "${{ secrets.SERVER_SSH_KEY }}" | head -c 50)
            KEY_END=$(echo "${{ secrets.SERVER_SSH_KEY }}" | tail -c 50)
            
            echo "–ù–∞—á–∞–ª–æ –∫–ª—é—á–∞: $KEY_START"
            echo "–ö–æ–Ω–µ—Ü –∫–ª—é—á–∞: $KEY_END"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç
            if echo "${{ secrets.SERVER_SSH_KEY }}" | grep -q "BEGIN.*PRIVATE KEY"; then
              echo "‚úÖ –§–æ—Ä–º–∞—Ç –∫–ª—é—á–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á)"
            else
              echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç! –î–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å 'BEGIN ... PRIVATE KEY'"
              echo "–ü–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤: $(echo "${{ secrets.SERVER_SSH_KEY }}" | head -c 100)"
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª–∏–Ω–Ω—ã–º)
            KEY_LENGTH=$(echo "${{ secrets.SERVER_SSH_KEY }}" | wc -c)
            echo "–î–ª–∏–Ω–∞ –∫–ª—é—á–∞: $KEY_LENGTH —Å–∏–º–≤–æ–ª–æ–≤"
            if [ "$KEY_LENGTH" -lt 500 ]; then
              echo "‚ö†Ô∏è  –ö–ª—é—á —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π! –í–æ–∑–º–æ–∂–Ω–æ, —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é."
            fi
          fi

          if [ -z "${{ secrets.SSH_PASSPHRASE }}" ]; then
            echo "‚ö†Ô∏è  SSH_PASSPHRASE –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –∫–ª—é—á –±–µ–∑ –ø–∞—Ä–æ–ª—è)"
          else
            echo "‚úÖ SSH_PASSPHRASE —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
          fi

          echo ""
          echo "–í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ secrets –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã!"

      - name: üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –¥–ª—è –¥–µ–ø–ª–æ—è
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–µ—Ä–µ–¥ –∞—Ä—Ö–∏–≤–∞—Ü–∏–µ–π:"
          ls -la
          echo ""
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ front/:"
          ls -la front/ | head -10
          echo ""

          # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤ –≤–æ –≤—Ä–µ–º—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏
          # –ò—Å–∫–ª—é—á–∞–µ–º node_modules –≤–æ –≤—Å–µ—Ö –ø–∞–ø–∫–∞—Ö, –Ω–æ –Ω–µ —Å–∞–º—É –ø–∞–ø–∫—É front
          tar -czf deploy.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='*.log' \
            --exclude='deploy.tar.gz' \
            --exclude='dist' \
            --exclude='front/node_modules' \
            --exclude='front/dist' \
            . 2>&1 | grep -v "file changed as we read it" || true

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω
          if [ -f deploy.tar.gz ]; then
            ls -lh deploy.tar.gz
            echo "‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞—Ä—Ö–∏–≤–∞
            echo ""
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∞—Ä—Ö–∏–≤–∞:"
            tar -tzf deploy.tar.gz | head -20
            echo ""
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è front/Dockerfile –≤ –∞—Ä—Ö–∏–≤–µ:"
            if tar -tzf deploy.tar.gz | grep -q "front/Dockerfile"; then
              echo "‚úÖ front/Dockerfile –Ω–∞–π–¥–µ–Ω –≤ –∞—Ä—Ö–∏–≤–µ"
            else
              echo "‚ùå front/Dockerfile –ù–ï –Ω–∞–π–¥–µ–Ω –≤ –∞—Ä—Ö–∏–≤–µ!"
              echo "–°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ front/:"
              tar -tzf deploy.tar.gz | grep "^front/" | head -20
              exit 1
            fi
          else
            echo "‚ùå –û—à–∏–±–∫–∞: –∞—Ä—Ö–∏–≤ –Ω–µ —Å–æ–∑–¥–∞–Ω"
            exit 1
          fi

      - name: üöÄ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          source: "deploy.tar.gz"
          target: "/home/${{ secrets.SERVER_USER }}/"

      - name: üìÇ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            cd /home/${{ secrets.SERVER_USER }}

            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–ø–∫—É
            rm -rf app

            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∏ —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º
            mkdir -p app
            tar -xzf deploy.tar.gz -C app
            rm deploy.tar.gz

            cd app
            echo "‚úÖ –§–∞–π–ª—ã —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω—ã"
            echo "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫:"
            ls -la
            echo ""
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ front:"
            ls -la front/ || echo "–ü–∞–ø–∫–∞ front –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            echo ""
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ front/Dockerfile:"
            cat front/Dockerfile || echo "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"

      - name: üèÉ‚Äç‚ôÇÔ∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            cd /home/${{ secrets.SERVER_USER }}/app

            echo "=== –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã ==="
            echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–Ω—è:"
            ls -la
            echo ""
            echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ front/:"
            ls -la front/ || echo "‚ùå –ü–∞–ø–∫–∞ front –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
            echo ""
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ front/Dockerfile:"
            if [ -f front/Dockerfile ]; then
              echo "‚úÖ front/Dockerfile –Ω–∞–π–¥–µ–Ω"
              head -5 front/Dockerfile
            else
              echo "‚ùå front/Dockerfile –ù–ï –Ω–∞–π–¥–µ–Ω!"
              exit 1
            fi
            echo ""
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ docker-compose.yml:"
            if [ -f docker-compose.yml ]; then
              echo "‚úÖ docker-compose.yml –Ω–∞–π–¥–µ–Ω"
            else
              echo "‚ùå docker-compose.yml –ù–ï –Ω–∞–π–¥–µ–Ω!"
              exit 1
            fi
            echo ""
            echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            sudo docker compose down || true
            echo "–ó–∞–ø—É—Å–∫ –Ω–æ–≤—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            timeout 300s sudo docker compose up -d --build
            echo "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            sleep 15

            echo ""
            echo "=== –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ==="
            sudo docker compose ps

            echo ""
            echo "=== –õ–æ–≥–∏ frontend ==="
            sudo docker compose logs --tail=50 frontend || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ frontend"

            echo ""
            echo "=== –õ–æ–≥–∏ nginx ==="
            sudo docker compose logs --tail=50 nginx || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ nginx"

            echo ""
            echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤ ==="
            sudo netstat -tlnp | grep -E ':(80|443|5173)' || sudo ss -tlnp | grep -E ':(80|443|5173)' || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç—ã"

            echo ""
            echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ frontend ==="
            sudo docker compose exec -T frontend wget -qO- http://localhost:5173 | head -20 || echo "Frontend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 5173"

            echo ""
            echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ nginx ==="
            curl -I http://localhost:80 || echo "Nginx –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 80"

            echo ""
            echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ firewall (ufw) ==="
            sudo ufw status || echo "ufw –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω"

            echo ""
            echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ firewall (iptables) ==="
            sudo iptables -L -n | grep -E '(80|443|5173)' || echo "–ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ø–æ—Ä—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

            echo ""
            echo "=== –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ç–∏ ==="
            ip addr show | grep -E 'inet ' || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ç–∏"

name: Docker Compose CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üõéÔ∏è –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö secrets
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è secrets..."

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ secrets
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "‚ùå SERVER_HOST –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            exit 1
          else
            echo "‚úÖ SERVER_HOST —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
          fi

          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "‚ùå SERVER_USER –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            exit 1
          else
            echo "‚úÖ SERVER_USER —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${{ secrets.SERVER_USER }}"
          fi

          if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
            echo "‚ùå SERVER_SSH_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –ø—É—Å—Ç–æ–π!"
            echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ secret –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ SERVER_SSH_KEY"
            exit 1
          else
            echo "‚úÖ SERVER_SSH_KEY —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª–æ –∫–ª—é—á–∞ (–±–µ–∑ –≤—ã–≤–æ–¥–∞ –≤—Å–µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ)
            KEY_START=$(echo "${{ secrets.SERVER_SSH_KEY }}" | head -c 50)
            KEY_END=$(echo "${{ secrets.SERVER_SSH_KEY }}" | tail -c 50)
            
            echo "–ù–∞—á–∞–ª–æ –∫–ª—é—á–∞: $KEY_START"
            echo "–ö–æ–Ω–µ—Ü –∫–ª—é—á–∞: $KEY_END"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç
            if echo "${{ secrets.SERVER_SSH_KEY }}" | grep -q "BEGIN.*PRIVATE KEY"; then
              echo "‚úÖ –§–æ—Ä–º–∞—Ç –∫–ª—é—á–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á)"
            else
              echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç! –î–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å 'BEGIN ... PRIVATE KEY'"
              echo "–ü–µ—Ä–≤—ã–µ 100 —Å–∏–º–≤–æ–ª–æ–≤: $(echo "${{ secrets.SERVER_SSH_KEY }}" | head -c 100)"
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª–∏–Ω–Ω—ã–º)
            KEY_LENGTH=$(echo "${{ secrets.SERVER_SSH_KEY }}" | wc -c)
            echo "–î–ª–∏–Ω–∞ –∫–ª—é—á–∞: $KEY_LENGTH —Å–∏–º–≤–æ–ª–æ–≤"
            if [ "$KEY_LENGTH" -lt 500 ]; then
              echo "‚ö†Ô∏è  –ö–ª—é—á —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π! –í–æ–∑–º–æ–∂–Ω–æ, —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é."
            fi
          fi

          if [ -z "${{ secrets.SSH_PASSPHRASE }}" ]; then
            echo "‚ö†Ô∏è  SSH_PASSPHRASE –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –∫–ª—é—á –±–µ–∑ –ø–∞—Ä–æ–ª—è)"
          else
            echo "‚úÖ SSH_PASSPHRASE —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
          fi

          echo ""
          echo "–í—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ secrets –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã!"

      - name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          source: "."
          target: "/home/${{ secrets.SERVER_USER }}/app"

      - name: üèÉ‚Äç‚ôÇÔ∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            cd /home/${{ secrets.SERVER_USER }}/app
            sudo docker compose down
            timeout 300s sudo docker compose up -d --build
            sleep 10 # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

name: Docker Compose CI/CD

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üõéÔ∏è –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–π –ø–∞–ø–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            rm -rf /home/${{ secrets.SERVER_USER }}/app
            mkdir -p /home/${{ secrets.SERVER_USER }}/app

      - name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          source: "." # –ß—Ç–æ –∫–æ–ø–∏—Ä—É–µ–º (–≤—Å—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–µ–ø–æ)
          target: "/home/${{ secrets.SERVER_USER }}/app" # –ö—É–¥–∞ –∫–æ–ø–∏—Ä—É–µ–º
          overwrite: true
          strip_components: 0

      - name: üèÉ‚Äç‚ôÇÔ∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            cd /home/${{ secrets.SERVER_USER }}/app

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–æ–≤:"
            ls -la
            echo ""
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ front/:"
            ls -la front/ || echo "‚ö†Ô∏è –ü–∞–ø–∫–∞ front –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            echo ""
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ front/Dockerfile:"
            if [ -f front/Dockerfile ]; then
              echo "‚úÖ front/Dockerfile –Ω–∞–π–¥–µ–Ω"
            else
              echo "‚ùå front/Dockerfile –ù–ï –Ω–∞–π–¥–µ–Ω!"
              echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ front/:"
              ls -la front/ 2>/dev/null || echo "–ü–∞–ø–∫–∞ front –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
              exit 1
            fi
            echo ""

            sudo docker compose down
            timeout 300s sudo docker compose up -d --build
            sleep 10 # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

            echo ""
            echo "=== –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ ==="
            sudo docker compose ps

name: Docker Compose CI/CD

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ›Žï¸ ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
        uses: actions/checkout@v4

      - name: ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ð¾Ð¹ Ð¿Ð°Ð¿ÐºÐ¸ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            rm -rf /home/${{ secrets.SERVER_USER }}/app
            mkdir -p /home/${{ secrets.SERVER_USER }}/app

      - name: ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ Ð¿Ð¾ SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          source: "." # Ð§Ñ‚Ð¾ ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ (Ð²ÑÑ‘ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ñ€ÐµÐ¿Ð¾)
          target: "/home/${{ secrets.SERVER_USER }}/app" # ÐšÑƒÐ´Ð° ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼
          overwrite: true
          strip_components: 0

      - name: ðŸƒâ€â™‚ï¸ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script: |
            cd /home/${{ secrets.SERVER_USER }}/app

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼
            echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ñ„Ð°Ð¹Ð»Ð¾Ð²:"
            ls -la
            echo ""
            echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° front/:"
            ls -la front/ || echo "âš ï¸ ÐŸÐ°Ð¿ÐºÐ° front Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
            echo ""
            echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° front/Dockerfile:"
            if [ -f front/Dockerfile ]; then
              echo "âœ… front/Dockerfile Ð½Ð°Ð¹Ð´ÐµÐ½"
            else
              echo "âŒ front/Dockerfile ÐÐ• Ð½Ð°Ð¹Ð´ÐµÐ½!"
              echo "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ front/:"
              ls -la front/ 2>/dev/null || echo "ÐŸÐ°Ð¿ÐºÐ° front Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
              exit 1
            fi
            echo ""

            # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð° Ñ ÑÐµÐºÑ€ÐµÑ‚Ð°Ð¼Ð¸ Ð´Ð»Ñ tg_bot
            echo "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°..."
            cat > .env << EOF
            BOT_TOKEN=${{ secrets.BOT_TOKEN }}
            ADMIN_CHAT_IDS=${{ secrets.ALLOWED_USER_IDS }}
            ALLOWED_USER_IDS=${{ secrets.ALLOWED_USER_IDS }}
            EOF
            echo "âœ… .env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½"
            echo ""

            sudo docker compose down
            timeout 300s sudo docker compose up -d --build
            sleep 10 # ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²

            echo ""
            echo "=== Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² ==="
            sudo docker compose ps
